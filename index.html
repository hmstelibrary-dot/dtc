<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏±‡∏ç‡∏´‡∏≤</title>
<script src="data.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background-color:#f5f5f5; color:#333; }
label { font-weight:bold; margin-top:10px; display:block; }
select, input { padding: 8px; margin: 5px 0; width: 220px; border:1px solid #ccc; border-radius:4px; }
button { padding: 8px 12px; margin:5px 5px 5px 0; border:none; border-radius:4px; background:#c8102e; color:white; cursor:pointer; transition:0.3s; }
button:hover { background:#a00e24; }
.result { margin-top:20px; padding:15px; border:1px solid #ccc; border-radius:6px; background:white; }
img { max-width:100%; border:1px solid #ccc; margin-top:5px; border-radius:4px; }

/* Tooltip */
.tooltip {
  position: relative;
  display: inline-block;
  cursor: pointer;
  color: #0073e6;
  font-weight: bold;
  margin-left: 6px;
}
.tooltip .tooltiptext {
  visibility: hidden;
  width: 240px;
  background-color: #333;
  color: #fff;
  text-align: left;
  border-radius: 6px;
  padding: 8px;
  position: absolute;
  z-index: 1;
  bottom: 125%; /* ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
  left: 50%;
  margin-left: -120px;
  opacity: 0;
  transition: opacity 0.3s;
  font-size: 12px;
}
.tooltip:hover .tooltiptext,
.tooltip:active .tooltiptext {
  visibility: visible;
  opacity: 1;
}

@media (max-width: 768px) {
  body { padding:15px; }
  select, input { width:100%; font-size:16px; }
  button { width:100%; margin:5px 0; }
  .result { font-size:14px; }
}
@media (max-width: 480px) {
  body { padding:10px; }
  select, input { width:100%; font-size:14px; }
  button { width:100%; font-size:14px; margin:5px 0; }
  .result { font-size:13px; padding:10px; }
}
</style>
</head>
<body>
<h2>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h2>

<label>Brand/‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠:</label>
<select id="brandSelect"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ --</option></select>

<label>Series/‡∏ã‡∏µ‡∏£‡∏µ‡πà‡∏¢‡πå:</label>
<select id="modelSelect"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Series --</option></select>

<label>Model/‡πÇ‡∏°‡πÄ‡∏î‡∏•:</label>
<select id="variantSelect"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Model --</option></select>

<label>DTC Code/‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</label>
<input list="codeList" id="codeInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô P0087">
<datalist id="codeList"></datalist>
<small style="color:gray;">* ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</small>

<div style="margin-top:10px;">
  <button onclick="clearSearch()">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
  <button onclick="saveJPEG()">Save ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
  <span class="tooltip">‚ÑπÔ∏è
    <span id="tooltipText" class="tooltiptext"></span>
  </span>
</div>

<div class="result" id="result">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>

<script>
// Element references
const brandSelect = document.getElementById('brandSelect');
const modelSelect = document.getElementById('modelSelect');
const variantSelect = document.getElementById('variantSelect');
const codeInput = document.getElementById('codeInput');
const codeList = document.getElementById('codeList');
const resultDiv = document.getElementById('result');
const tooltipText = document.getElementById('tooltipText');

// Load brand dropdown
[...new Set(data.map(d=>d.brand))].forEach(b=>{
  let opt=document.createElement('option');
  opt.value=b; opt.text=b;
  brandSelect.add(opt);
});

// Series/Model dropdown
brandSelect.addEventListener('change', function(){
  modelSelect.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Series --</option>';
  variantSelect.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Model --</option>';
  codeList.innerHTML=''; codeInput.value=''; resultDiv.innerHTML='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
  const models = [...new Set(data.filter(d=>d.brand===this.value).map(d=>d.model))];
  models.forEach(m=>{
    let opt=document.createElement('option');
    opt.value=m; opt.text=m;
    modelSelect.add(opt);
  });
});

modelSelect.addEventListener('change', function(){
  variantSelect.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Model --</option>';
  codeList.innerHTML=''; codeInput.value=''; resultDiv.innerHTML='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
  const brand = brandSelect.value;
  const variants = data.filter(d=>d.brand===brand && d.model===this.value).map(d=>d.variant);
  variants.forEach(v=>{
    let opt=document.createElement('option');
    opt.value=v; opt.text=v;
    variantSelect.add(opt);
  });
});

variantSelect.addEventListener('change', function(){
  codeInput.value=''; resultDiv.innerHTML='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'; codeList.innerHTML='';
  const brand = brandSelect.value;
  const model = modelSelect.value;
  const variant = variantSelect.value;
  const vehicle = data.find(d=>d.brand===brand && d.model===model && d.variant===variant);
  if(vehicle){
    vehicle.codes.forEach(c=>{
      let opt = document.createElement("option");
      opt.value = c.code;
      codeList.appendChild(opt);
    });
  }
});

// Auto search when typing code
codeInput.addEventListener('input', searchCode);

// Search function
function searchCode(){
  const brand = brandSelect.value;
  const model = modelSelect.value;
  const variant = variantSelect.value;
  const code = codeInput.value.trim().toUpperCase();
  if(!brand||!model||!variant||!code){
    resultDiv.innerHTML='<span style="color:red;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™</span>'; return;
  }
  const vehicle = data.find(d=>d.brand===brand && d.model===model && d.variant===variant);
  if(!vehicle){ resultDiv.innerHTML='‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ'; return; }
  const codeData = vehicle.codes.find(c=>c.code===code);
  if(!codeData){ resultDiv.innerHTML='‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡∏µ‡πâ'; return; }
  const imagesHtml = codeData.images.map(img=>`<img src="${img}" alt="${codeData.code}">`).join('');
  resultDiv.innerHTML = `
    <b>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠:</b> ${brand}<br>
    <b>Series:</b> ${model}<br>
    <b>Model:</b> ${variant}<br>
    <b>‡∏£‡∏´‡∏±‡∏™:</b> ${codeData.code}<br>
    <b>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</b> ${codeData.description}<br>
    <b>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:</b><br> - ${codeData.possible_causes.join('<br> - ')}<br>
    <b>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</b><br>${codeData.diagnosis_steps.map((s,i)=>(i+1)+'. '+s).join('<br>')}<br>
    <b>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</b><br>${codeData.repair_steps.map((s,i)=>(i+1)+'. '+s).join('<br>')}<br>
    <b>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:</b> ${codeData.reference}<br>
    <b>‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö:</b><br>${imagesHtml}
  `;
}

// Clear search
function clearSearch(){
  brandSelect.value=''; modelSelect.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Series --</option>';
  variantSelect.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Model --</option>';
  codeInput.value=''; codeList.innerHTML=''; resultDiv.innerHTML='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
}

// Save JPEG (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà, ‡∏Ñ‡∏≠‡∏°‡∏Ø ‚Üí ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î)
function saveJPEG(){
  if(resultDiv.innerHTML.trim()===""){ alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏ü"); return; }
  const a4WidthPx = 2480;
  html2canvas(resultDiv,{scale:2,useCORS:true}).then(canvas=>{
    const ratio = a4WidthPx / canvas.width;
    const imgWidth = canvas.width*ratio;
    const imgHeight = canvas.height*ratio;
    const tmpCanvas = document.createElement('canvas');
    tmpCanvas.width = imgWidth;
    tmpCanvas.height = imgHeight;
    const ctx = tmpCanvas.getContext('2d');
    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,imgWidth,imgHeight);
    ctx.drawImage(canvas,0,0,imgWidth,imgHeight);
    const imgData = tmpCanvas.toDataURL("image/jpeg",1.0);

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    if(isMobile){
      const newTab = window.open();
      newTab.document.write(`<img src="${imgData}" style="width:100%;height:auto;">`);
    } else {
      const link = document.createElement('a');
      link.download = `${codeInput.value||'output'}.jpeg`;
      link.href = imgData;
      link.click();
    }
  });
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° tooltip ‡∏ï‡∏≤‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
tooltipText.textContent = isMobile 
  ? "üì± ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚Üí ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà ‚Üí ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏Ñ‡∏•‡∏±‡∏á‡∏†‡∏≤‡∏û" 
  : "üíª ‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå: ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚Üí ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥";
</script>
</body>
</html>