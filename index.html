<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ค้นหารหัสปัญหา</title>
<script src="data.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
body { font-family: sans-serif; padding: 20px; }
select, input { padding: 5px; margin: 5px; width: 220px; }
button { padding: 5px 10px; margin: 5px; }
.result { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
img { max-width: 100%; border: 1px solid #ccc; margin-top: 5px; }
</style>
</head>
<body>
<h2>ค้นหารหัสปัญหา</h2>

<label>ยี่ห้อ:</label><br>
<select id="brandSelect"><option value="">-- เลือกยี่ห้อ --</option></select><br>

<label>รุ่น/Model:</label><br>
<select id="modelSelect"><option value="">-- เลือกรุ่น --</option></select><br>

<label>Variant:</label><br>
<select id="variantSelect"><option value="">-- เลือก Variant --</option></select><br>

<label>รหัสปัญหา:</label><br>
<input type="text" id="codeInput" placeholder="เช่น P0301">
<button onclick="searchCode()">ค้นหา</button>

<div class="result" id="result">ยังไม่มีการค้นหา</div>
<button onclick="savePDF()">Save PDF</button>
<button onclick="saveJPEG()">Save JPEG</button>

<script>
// โหลด dropdown
const brandSelect = document.getElementById('brandSelect');
const modelSelect = document.getElementById('modelSelect');
const variantSelect = document.getElementById('variantSelect');
const codeInput = document.getElementById('codeInput');
const resultDiv = document.getElementById('result');

[...new Set(data.map(d=>d.brand))].forEach(b=>{ let opt=document.createElement('option'); opt.value=b; opt.text=b; brandSelect.add(opt); });

brandSelect.addEventListener('change', function(){
  modelSelect.innerHTML='<option value="">-- เลือกรุ่น --</option>';
  variantSelect.innerHTML='<option value="">-- เลือก Variant --</option>';
  codeInput.value=''; resultDiv.innerHTML='ยังไม่มีการค้นหา';
  const models = [...new Set(data.filter(d=>d.brand===this.value).map(d=>d.model))];
  models.forEach(m=>{ let opt=document.createElement('option'); opt.value=m; opt.text=m; modelSelect.add(opt); });
});

modelSelect.addEventListener('change', function(){
  variantSelect.innerHTML='<option value="">-- เลือก Variant --</option>';
  codeInput.value=''; resultDiv.innerHTML='ยังไม่มีการค้นหา';
  const brand = brandSelect.value;
  const variants = data.filter(d=>d.brand===brand && d.model===this.value).map(d=>d.variant);
  variants.forEach(v=>{ let opt=document.createElement('option'); opt.value=v; opt.text=v; variantSelect.add(opt); });
});

variantSelect.addEventListener('change', function(){
  codeInput.value=''; resultDiv.innerHTML='ยังไม่มีการค้นหา';
});

function searchCode(){
  const brand = brandSelect.value;
  const model = modelSelect.value;
  const variant = variantSelect.value;
  const code = codeInput.value.trim().toUpperCase();

  if(!brand||!model||!variant||!code){ resultDiv.innerHTML='<span style="color:red;">กรุณาเลือกครบและใส่รหัส</span>'; return; }

  const vehicle = data.find(d=>d.brand===brand && d.model===model && d.variant===variant);
  if(!vehicle){ resultDiv.innerHTML='ไม่พบรถคันนี้'; return; }

  const codeData = vehicle.codes.find(c=>c.code===code);
  if(!codeData){ resultDiv.innerHTML='ไม่พบรหัสปัญหานี้'; return; }

  resultDiv.innerHTML = `
    <b>ยี่ห้อ:</b> ${brand}<br>
    <b>รุ่น:</b> ${model}<br>
    <b>Variant:</b> ${variant}<br>
    <b>รหัส:</b> ${codeData.code}<br>
    <b>คำอธิบาย:</b> ${codeData.description}<br>
    <b>สาเหตุ:</b><br> - ${codeData.possible_causes.join('<br> - ')}<br>
    <b>วิธีตรวจสอบ:</b><br>${codeData.diagnosis_steps.map((s,i)=>(i+1)+'. '+s).join('<br>')}<br>
    <b>แก้ไข:</b><br>${codeData.repair_steps.map((s,i)=>(i+1)+'. '+s).join('<br>')}<br>
    <b>เอกสารอ้างอิง:</b> ${codeData.reference}<br>
    <b>ภาพประกอบ:</b><br>
    <img src="${codeData.image}" alt="${codeData.code}">
  `;
}

// Save PDF A4 Portrait
function savePDF(){
  if(resultDiv.innerHTML.trim()===""){ alert("ไม่มีข้อมูลให้เซฟ"); return; }
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','mm','a4');

  html2canvas(resultDiv, {scale:2}).then(canvas=>{
      const imgData = canvas.toDataURL('image/png');
      const pdfWidth = 190;
      const pdfHeight = canvas.height * pdfWidth / canvas.width;
      pdf.addImage(imgData,'PNG',10,10,pdfWidth,pdfHeight);
      pdf.save(`${codeInput.value || 'output'}.pdf`);
  });
}

// Save JPEG
function saveJPEG(){
  if(resultDiv.innerHTML.trim()===""){ alert("ไม่มีข้อมูลให้เซฟ"); return; }
  html2canvas(resultDiv).then(canvas=>{
      const link = document.createElement("a");
      link.download = `${codeInput.value || 'output'}.jpeg`;
      link.href = canvas.toDataURL("image/jpeg",1.0);
      link.click();
  });
}
</script>
</body>
</html>