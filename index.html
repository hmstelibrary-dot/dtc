<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ค้นหารหัสปัญหา</title>
<script src="data.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background-color:#f5f5f5; color:#333; }
label { font-weight:bold; margin-top:10px; display:block; }
select, input { padding: 8px; margin: 5px 0; width: 220px; border:1px solid #ccc; border-radius:4px; }
button { padding: 8px 12px; margin:5px 5px 5px 0; border:none; border-radius:4px; background:#c8102e; color:white; cursor:pointer; transition:0.3s; }
button:hover { background:#a00e24; }
.result { margin-top:20px; padding:15px; border:1px solid #ccc; border-radius:6px; background:white; }
img { max-width:100%; border:1px solid #ccc; margin-top:5px; border-radius:4px; }
@media (max-width: 768px) {
  body { padding:15px; }
  select, input { width:100%; font-size:16px; }
  button { width:100%; margin:5px 0; }
  .result { font-size:14px; }
}
@media (max-width: 480px) {
  body { padding:10px; }
  select, input { width:100%; font-size:14px; }
  button { width:100%; font-size:14px; margin:5px 0; }
  .result { font-size:13px; padding:10px; }
}
</style>
</head>
<body>
<h2>ค้นหารหัสปัญหา</h2>

<label>Brand/ยี่ห้อ:</label>
<select id="brandSelect"><option value="">-- เลือกยี่ห้อ --</option></select>

<label>Series/ซีรี่ย์:</label>
<select id="modelSelect"><option value="">-- เลือก Series --</option></select>

<label>Model/โมเดล:</label>
<select id="variantSelect"><option value="">-- เลือก Model --</option></select>

<label>DTC Code/รหัสปัญหา:</label>
<input list="codeList" id="codeInput" placeholder="เช่น P0087">
<datalist id="codeList"></datalist>
<small style="color:gray;">* ใส่รหัสแล้วจะแสดงผลอัตโนมัติ</small>

<div style="margin-top:10px;">
  <button onclick="clearSearch()">เคลียร์การค้นหา</button>
  <button id="saveImageBtn" onclick="saveJPEG()">Save รูปภาพ</button>
</div>

<div class="result" id="result">ยังไม่มีการค้นหา</div>

<script>
// Element references
const brandSelect = document.getElementById('brandSelect');
const modelSelect = document.getElementById('modelSelect');
const variantSelect = document.getElementById('variantSelect');
const codeInput = document.getElementById('codeInput');
const codeList = document.getElementById('codeList');
const resultDiv = document.getElementById('result');

// ตรวจสอบมือถือหรือ desktop
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
if(isMobile){
  document.getElementById('saveImageBtn').style.display = 'none';
}

// Load brand dropdown
[...new Set(data.map(d=>d.brand))].forEach(b=>{
  let opt=document.createElement('option');
  opt.value=b; opt.text=b;
  brandSelect.add(opt);
});

// Series/Model dropdown
brandSelect.addEventListener('change', function(){
  modelSelect.innerHTML='<option value="">-- เลือก Series --</option>';
  variantSelect.innerHTML='<option value="">-- เลือก Model --</option>';
  codeList.innerHTML=''; codeInput.value=''; resultDiv.innerHTML='ยังไม่มีการค้นหา';
  const models = [...new Set(data.filter(d=>d.brand===this.value).map(d=>d.model))];
  models.forEach(m=>{
    let opt=document.createElement('option');
    opt.value=m; opt.text=m;
    modelSelect.add(opt);
  });
});

modelSelect.addEventListener('change', function(){
  variantSelect.innerHTML='<option value="">-- เลือก Model --</option>';
  codeList.innerHTML=''; codeInput.value=''; resultDiv.innerHTML='ยังไม่มีการค้นหา';
  const brand = brandSelect.value;
  const variants = data.filter(d=>d.brand===brand && d.model===this.value).map(d=>d.variant);
  variants.forEach(v=>{
    let opt=document.createElement('option');
    opt.value=v; opt.text=v;
    variantSelect.add(opt);
  });
});

variantSelect.addEventListener('change', function(){
  codeInput.value=''; resultDiv.innerHTML='ยังไม่มีการค้นหา'; codeList.innerHTML='';
  const brand = brandSelect.value;
  const model = modelSelect.value;
  const variant = variantSelect.value;
  const vehicle = data.find(d=>d.brand===brand && d.model===model && d.variant===variant);
  if(vehicle){
    vehicle.codes.forEach(c=>{
      let opt = document.createElement("option");
      opt.value = c.code;
      codeList.appendChild(opt);
    });
  }
});

// Auto search when typing code
codeInput.addEventListener('input', searchCode);

// Search function
function searchCode(){
  const brand = brandSelect.value;
  const model = modelSelect.value;
  const variant = variantSelect.value;
  const code = codeInput.value.trim().toUpperCase();
  if(!brand||!model||!variant||!code){
    resultDiv.innerHTML='<span style="color:red;">กรุณาเลือกครบและใส่รหัส</span>'; return;
  }
  const vehicle = data.find(d=>d.brand===brand && d.model===model && d.variant===variant);
  if(!vehicle){ resultDiv.innerHTML='ไม่พบรถคันนี้'; return; }
  const codeData = vehicle.codes.find(c=>c.code===code);
  if(!codeData){ resultDiv.innerHTML='ไม่พบรหัสปัญหานี้'; return; }
  const imagesHtml = codeData.images.map(img=>`<img src="${img}" alt="${codeData.code}">`).join('');
  resultDiv.innerHTML = `
    <b>ยี่ห้อ:</b> ${brand}<br>
    <b>Series:</b> ${model}<br>
    <b>Model:</b> ${variant}<br>
    <b>รหัส:</b> ${codeData.code}<br>
    <b>คำอธิบาย:</b> ${codeData.description}<br>
    <b>สาเหตุ:</b><br> - ${codeData.possible_causes.join('<br> - ')}<br>
    <b>วิธีตรวจสอบ:</b><br>${codeData.diagnosis_steps.map((s,i)=>(i+1)+'. '+s).join('<br>')}<br>
    <b>แก้ไข:</b><br>${codeData.repair_steps.map((s,i)=>(i+1)+'. '+s).join('<br>')}<br>
    <b>เอกสารอ้างอิง:</b> ${codeData.reference}<br>
    <b>ภาพประกอบ:</b><br>${imagesHtml}
  `;
}

// Clear search
function clearSearch(){
  brandSelect.value=''; modelSelect.innerHTML='<option value="">-- เลือก Series --</option>';
  variantSelect.innerHTML='<option value="">-- เลือก Model --</option>';
  codeInput.value=''; codeList.innerHTML=''; resultDiv.innerHTML='ยังไม่มีการค้นหา';
}

// Save JPEG
function saveJPEG(){
  if(resultDiv.innerHTML.trim()===""){ alert("ไม่มีข้อมูลให้เซฟ"); return; }
  html2canvas(resultDiv,{scale:2,useCORS:true}).then(canvas=>{
    const link = document.createElement('a');
    link.download = `${codeInput.value||'output'}.jpeg`;
    link.href = canvas.toDataURL("image/jpeg",1.0);
    link.click();
  });
}
</script>
</body>
</html>