<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Admin - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏±‡∏ç‡∏´‡∏≤</title>
<script src="data.js"></script>
<style>
/* ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ Hino: ‡πÅ‡∏î‡∏á #c8102e, ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô #003366, ‡∏Ç‡∏≤‡∏ß #ffffff */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  padding: 20px;
  max-width: 1000px;
  background-color: #f2f2f2;
  color: #333;
}

h1, h2 {
  color: #c8102e;
}

input, textarea, button, select {
  padding: 8px;
  margin: 5px 0;
  width: 100%;
  box-sizing: border-box;
  border-radius: 5px;
  border: 1px solid #ccc;
  font-size: 14px;
}

input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: #c8102e;
  box-shadow: 0 0 5px rgba(200, 16, 46, 0.5);
}

textarea { resize: vertical; }

.vehicle {
  border: 1px solid #c8102e;
  padding: 15px;
  margin-bottom: 12px;
  background-color: #ffffff;
  border-radius: 8px;
}

.code {
  border: 1px dashed #003366;
  padding: 12px;
  margin: 6px 0;
  background: #f9f9f9;
  border-radius: 6px;
}

button {
  cursor: pointer;
  transition: 0.3s;
  font-weight: bold;
}

button.small {
  width: auto;
  padding: 5px 12px;
  margin: 3px;
  background-color: #003366;
  color: white;
  border: none;
  border-radius: 5px;
}

button.small:hover {
  background-color: #c8102e;
}

/* ‡∏õ‡∏∏‡πà‡∏° Undo & Save ‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° */
.form-header {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 15px;
}

#undoBtn {
  background-color: #ff6600;
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 5px;
  font-weight: bold;
}

#undoBtn:hover { background-color: #cc5200; }

#saveBtn {
  background-color: #003366;
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 5px;
  font-weight: bold;
}

#saveBtn:hover { background-color: #c8102e; }

/* Placeholder ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
::placeholder { color: #888; }

/* ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
  gap: 15px;
}

.form-grid textarea {
  grid-column: span 2;
}

button.add-btn { grid-column: span 2; }

/* Responsive */
@media (max-width: 768px) {
  input, textarea, select, button { font-size: 14px; }
  .form-grid { grid-template-columns: 1fr; }
  .form-header { flex-direction: column; }
}
</style>
</head>
<body>
<h1>Admin - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h1>

<div class="form-header">
  <button id="undoBtn" onclick="undoDelete()" style="display:none;">Undo ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
  <button id="saveBtn" onclick="saveData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå data.js</button>
</div>

<h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</h2>
<div class="form-grid">
  <input list="brandList" id="brand" placeholder="Brand/‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠">
  <datalist id="brandList"></datalist>

  <input list="modelList" id="model" placeholder="Series/‡∏ã‡∏µ‡∏£‡∏µ‡πà‡∏¢‡πå">
  <datalist id="modelList"></datalist>

  <input list="variantList" id="variant" placeholder="Model/‡πÇ‡∏°‡πÄ‡∏î‡∏•">
  <datalist id="variantList"></datalist>

  <input type="text" id="code" placeholder="DTC Code/‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏±‡∏ç‡∏´‡∏≤">
  <textarea id="desc" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢"></textarea>
  <textarea id="causes" placeholder="‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏ô‡∏∂‡πà‡∏á)"></textarea>
  <textarea id="diagnosis" placeholder="‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)"></textarea>
  <textarea id="repair" placeholder="‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)"></textarea>
  <input type="text" id="reference" placeholder="‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á">
  <textarea id="image" placeholder="URL ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠ 1 ‡∏£‡∏π‡∏õ)"></textarea>
  <button onclick="addData()" class="add-btn">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
</div>

<h2>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
<input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠/‡∏ã‡∏µ‡∏£‡∏µ‡πà‡∏¢‡πå/‡πÇ‡∏°‡πÄ‡∏î‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏±‡∏ç‡∏´‡∏≤/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢" oninput="renderList()">

<div id="list"></div>

<script>
let undoStack = [];
let isChanged = false;

function markChanged() {
  isChanged = true;
  document.getElementById("saveBtn").style.display = "inline-block";
}

// ‡πÄ‡∏ï‡∏¥‡∏° datalist ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
function updateDatalists(){
  const brands = [...new Set(data.map(d=>d.brand))];
  const models = [...new Set(data.map(d=>d.model))];
  const variants = [...new Set(data.map(d=>d.variant))];

  const brandList = document.getElementById("brandList");
  const modelList = document.getElementById("modelList");
  const variantList = document.getElementById("variantList");

  brandList.innerHTML = ''; modelList.innerHTML = ''; variantList.innerHTML = '';

  brands.forEach(b=>{
    const opt=document.createElement('option'); opt.value=b; brandList.appendChild(opt);
  });
  models.forEach(m=>{
    const opt=document.createElement('option'); opt.value=m; modelList.appendChild(opt);
  });
  variants.forEach(v=>{
    const opt=document.createElement('option'); opt.value=v; variantList.appendChild(opt);
  });
}

function renderList(){
  updateDatalists();
  const query = document.getElementById("searchInput").value.toLowerCase();
  const listDiv = document.getElementById("list");
  listDiv.innerHTML = "";
  data.forEach((v,i)=>{
    const vehicleText = `${v.brand} ${v.model} ${v.variant}`.toLowerCase();
    const matchedCodes = v.codes.filter(c => 
      vehicleText.includes(query) || c.code.toLowerCase().includes(query) || c.description.toLowerCase().includes(query)
    );
    if(matchedCodes.length>0){
      const vehicleDiv = document.createElement("div");
      vehicleDiv.className = "vehicle";
      vehicleDiv.innerHTML = `<h3>${v.brand} ${v.model} ${v.variant} 
        <button class="small" onclick="deleteData(${i})">‡∏•‡∏ö‡∏£‡∏ñ‡∏ô‡∏µ‡πâ</button></h3>`;

      matchedCodes.forEach((c,j)=>{
        const codeDiv = document.createElement("div");
        codeDiv.className = "code";
        codeDiv.innerHTML = `
          <b>‡∏£‡∏´‡∏±‡∏™:</b> <input value="${c.code}" onchange="updateCode(${i},${j},'code',this.value)"><br>
          <b>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</b> <textarea onchange="updateCode(${i},${j},'description',this.value)">${c.description}</textarea><br>
          <b>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:</b> <textarea onchange="updateCode(${i},${j},'possible_causes',this.value)">${c.possible_causes.join("\n")}</textarea><br>
          <b>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</b> <textarea onchange="updateCode(${i},${j},'diagnosis_steps',this.value)">${c.diagnosis_steps.join("\n")}</textarea><br>
          <b>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</b> <textarea onchange="updateCode(${i},${j},'repair_steps',this.value)">${c.repair_steps.join("\n")}</textarea><br>
          <b>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:</b> <input value="${c.reference}" onchange="updateCode(${i},${j},'reference',this.value)"><br>
          <b>‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (URL):</b> <textarea onchange="updateCode(${i},${j},'images',this.value)">${c.images.join("\n")}</textarea><br>
          <button class="small" onclick="deleteCode(${i},${j})">‡∏•‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ</button>
        `;
        vehicleDiv.appendChild(codeDiv);
      });
      listDiv.appendChild(vehicleDiv);
    }
  });
}

function addData(){
  const brand=document.getElementById("brand").value.trim();
  const model=document.getElementById("model").value.trim();
  const variant=document.getElementById("variant").value.trim();
  const code=document.getElementById("code").value.trim();
  const desc=document.getElementById("desc").value.trim();
  const causes=document.getElementById("causes").value.split("\n").map(s=>s.trim()).filter(s=>s);
  const diagnosis=document.getElementById("diagnosis").value.split("\n").map(s=>s.trim()).filter(s=>s);
  const repair=document.getElementById("repair").value.split("\n").map(s=>s.trim()).filter(s=>s);
  const reference=document.getElementById("reference").value.trim();
  const images=document.getElementById("image").value.split("\n").map(s=>s.trim()).filter(s=>s);

  if(!brand||!model||!variant||!code||!desc){
    alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  let vehicle = data.find(d=>d.brand===brand && d.model===model && d.variant===variant);
  const codeObj = {code,description:desc,possible_causes:causes,diagnosis_steps:diagnosis,repair_steps:repair,reference,images};
  
  if(vehicle){
    vehicle.codes.push(codeObj);
  }else{
    data.push({brand,model,variant,codes:[codeObj]});
  }

  markChanged();

  document.getElementById("brand").value="";
  document.getElementById("model").value="";
  document.getElementById("variant").value="";
  document.getElementById("code").value="";
  document.getElementById("desc").value="";
  document.getElementById("causes").value="";
  document.getElementById("diagnosis").value="";
  document.getElementById("repair").value="";
  document.getElementById("reference").value="";
  document.getElementById("image").value="";

  renderList();
}

function updateCode(vIndex,cIndex,field,value){
  const codeObj = data[vIndex].codes[cIndex];
  if(['possible_causes','diagnosis_steps','repair_steps','images'].includes(field)){
    codeObj[field] = value.split("\n").map(s=>s.trim()).filter(s=>s);
  } else {
    codeObj[field] = value;
  }
  markChanged();
  renderList();
}

function deleteData(index){
  if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏ñ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
    undoStack.push(JSON.parse(JSON.stringify(data)));
    data.splice(index,1);
    markChanged();
    showUndo(true);
    renderList();
  }
}

function deleteCode(vIndex,cIndex){
  if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
    undoStack.push(JSON.parse(JSON.stringify(data)));
    data[vIndex].codes.splice(cIndex,1);
    markChanged();
    showUndo(true);
    renderList();
  }
}

function undoDelete(){
  if(undoStack.length>0){
    data.length=0;
    Object.assign(data, undoStack.pop());
    markChanged();
    showUndo(undoStack.length>0);
    alert("‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    renderList();
  }
}

function showUndo(show){
  document.getElementById("undoBtn").style.display = show ? "inline-block" : "none";
}

function saveData(){
  const blob = new Blob([`const data = ${JSON.stringify(data,null,2)};`],{type:"application/javascript"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="data.js";
  a.click();
  URL.revokeObjectURL(url);
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  isChanged = false;
  document.getElementById("saveBtn").style.display = "none";
}

renderList();
</script>
</body>
</html>