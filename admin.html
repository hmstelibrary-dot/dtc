<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Admin - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏±‡∏ç‡∏´‡∏≤</title>
<script src="data.js"></script>
<style>
body { font-family: sans-serif; padding: 20px; max-width: 1000px; }
input, textarea, button, select { padding: 5px; margin: 3px; width: 100%; box-sizing: border-box; }
textarea { resize: vertical; }
.vehicle { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
.code { border: 1px dashed #999; padding: 10px; margin: 5px 0; background:#f9f9f9; }
button.small { width: auto; padding: 3px 8px; margin: 2px; }
#undoBtn, #saveBtn { margin-bottom: 20px; }
#saveBtn { display: none; background: #28a745; color: white; border: none; }
</style>
</head>
<body>
<h1>Admin - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h1>

<button id="undoBtn" onclick="undoDelete()" style="display:none;">Undo ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
<button id="saveBtn" onclick="saveData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå data.js</button>

<h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</h2>
<input type="text" id="brand" placeholder="‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠">
<input type="text" id="model" placeholder="‡∏£‡∏∏‡πà‡∏ô">
<input type="text" id="variant" placeholder="Variant">
<input type="text" id="code" placeholder="‡∏£‡∏´‡∏±‡∏™">
<textarea id="desc" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢"></textarea>
<textarea id="causes" placeholder="‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏ô‡∏∂‡πà‡∏á)"></textarea>
<textarea id="diagnosis" placeholder="‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)"></textarea>
<textarea id="repair" placeholder="‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)"></textarea>
<input type="text" id="reference" placeholder="‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á">
<button onclick="addData()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>

<h2>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
<input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠/‡∏£‡∏∏‡πà‡∏ô/Variant/‡∏£‡∏´‡∏±‡∏™/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢" oninput="renderList()">

<div id="list"></div>

<script>
let undoStack = [];
let isChanged = false;

function markChanged() {
  isChanged = true;
  document.getElementById("saveBtn").style.display = "inline-block";
}

function renderList(){
  const query = document.getElementById("searchInput").value.toLowerCase();
  const listDiv = document.getElementById("list");
  listDiv.innerHTML = "";
  data.forEach((v,i)=>{
    const vehicleText = `${v.brand} ${v.model} ${v.variant}`.toLowerCase();
    const matchedCodes = v.codes.filter(c => 
      vehicleText.includes(query) || c.code.toLowerCase().includes(query) || c.description.toLowerCase().includes(query)
    );
    if(matchedCodes.length>0){
      const vehicleDiv = document.createElement("div");
      vehicleDiv.className = "vehicle";
      vehicleDiv.innerHTML = `<h3>${v.brand} ${v.model} ${v.variant} 
        <button class="small" onclick="deleteData(${i})">‡∏•‡∏ö‡∏£‡∏ñ‡∏ô‡∏µ‡πâ</button></h3>`;

      matchedCodes.forEach((c,j)=>{
        const codeDiv = document.createElement("div");
        codeDiv.className = "code";
        codeDiv.innerHTML = `
          <b>‡∏£‡∏´‡∏±‡∏™:</b> <input value="${c.code}" onchange="updateCode(${i},${j},'code',this.value)"><br>
          <b>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</b> <textarea onchange="updateCode(${i},${j},'description',this.value)">${c.description}</textarea><br>
          <b>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:</b> <textarea onchange="updateCode(${i},${j},'possible_causes',this.value)">${c.possible_causes.join("\n")}</textarea><br>
          <b>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</b> <textarea onchange="updateCode(${i},${j},'diagnosis_steps',this.value)">${c.diagnosis_steps.join("\n")}</textarea><br>
          <b>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</b> <textarea onchange="updateCode(${i},${j},'repair_steps',this.value)">${c.repair_steps.join("\n")}</textarea><br>
          <b>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:</b> <input value="${c.reference}" onchange="updateCode(${i},${j},'reference',this.value)"><br>
          <button class="small" onclick="deleteCode(${i},${j})">‡∏•‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ</button>
        `;
        vehicleDiv.appendChild(codeDiv);
      });
      listDiv.appendChild(vehicleDiv);
    }
  });
}

function addData(){
  const brand=document.getElementById("brand").value.trim();
  const model=document.getElementById("model").value.trim();
  const variant=document.getElementById("variant").value.trim();
  const code=document.getElementById("code").value.trim();
  const desc=document.getElementById("desc").value.trim();
  const causes=document.getElementById("causes").value.split("\n").map(s=>s.trim()).filter(s=>s);
  const diagnosis=document.getElementById("diagnosis").value.split("\n").map(s=>s.trim()).filter(s=>s);
  const repair=document.getElementById("repair").value.split("\n").map(s=>s.trim()).filter(s=>s);
  const reference=document.getElementById("reference").value.trim();

  if(!brand||!model||!variant||!code||!desc){
    alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  let vehicle = data.find(d=>d.brand===brand && d.model===model && d.variant===variant);
  const codeObj = {code,description:desc,possible_causes:causes,diagnosis_steps:diagnosis,repair_steps:repair,reference};
  
  if(vehicle){
    vehicle.codes.push(codeObj);
  }else{
    data.push({brand,model,variant,codes:[codeObj]});
  }

  markChanged();

  document.getElementById("brand").value="";
  document.getElementById("model").value="";
  document.getElementById("variant").value="";
  document.getElementById("code").value="";
  document.getElementById("desc").value="";
  document.getElementById("causes").value="";
  document.getElementById("diagnosis").value="";
  document.getElementById("repair").value="";
  document.getElementById("reference").value="";

  renderList();
}

function updateCode(vIndex,cIndex,field,value){
  const codeObj = data[vIndex].codes[cIndex];
  if(['possible_causes','diagnosis_steps','repair_steps'].includes(field)){
    codeObj[field] = value.split("\n").map(s=>s.trim()).filter(s=>s);
  } else {
    codeObj[field] = value;
  }
  markChanged();
  renderList();
}

function deleteData(index){
  if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏ñ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
    undoStack.push(JSON.parse(JSON.stringify(data)));
    data.splice(index,1);
    markChanged();
    showUndo(true);
    renderList();
  }
}

function deleteCode(vIndex,cIndex){
  if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
    undoStack.push(JSON.parse(JSON.stringify(data)));
    data[vIndex].codes.splice(cIndex,1);
    markChanged();
    showUndo(true);
    renderList();
  }
}

function undoDelete(){
  if(undoStack.length>0){
    data.length=0;
    Object.assign(data, undoStack.pop());
    markChanged();
    showUndo(undoStack.length>0);
    alert("‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    renderList();
  }
}

function showUndo(show){
  document.getElementById("undoBtn").style.display = show ? "inline-block" : "none";
}

function saveData(){
  const blob = new Blob([`const data = ${JSON.stringify(data,null,2)};`],{type:"application/javascript"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="data.js";
  a.click();
  URL.revokeObjectURL(url);
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  isChanged = false;
  document.getElementById("saveBtn").style.display = "none";
}

renderList();
</script>
</body>
</html>